// File: src/server-with-auth.ts (actualizaci√≥n del servidor existente)

import express from 'express';
import cors from 'cors';
import path from 'path';
import fs from 'fs';

// Importar rutas existentes
import { consultasRouter } from './modules/consultas/consultas.routes';
import { pacientesRouter } from './modules/pacientes/pacientes.routes';
import { laboratorioRouter } from './modules/laboratorio/laboratorio.routes';
import { historiaRouter } from './modules/historia/historia.routes';

// ‚úÖ NUEVO: Importar m√≥dulo de autenticaci√≥n
import { authRouter, requireAuth, requireRoles } from './modules/auth';

// Middleware existente
import { errorHandler } from './middleware/errorHandler';

const app = express();
const PORT = process.env.PORT || 4000;

// ===============================================================
// üöÄ CONFIGURACI√ìN INICIAL (sin cambios)
// ===============================================================

console.log('üè• Iniciando servidor de Historia Cl√≠nica con Autenticaci√≥n...');

// Crear directorios necesarios
const UPLOADS_DIR = path.join(process.cwd(), 'uploads');
const UPLOADS_TMP_DIR = path.join(process.cwd(), 'uploads_tmp');

function ensureDirectories() {
  [UPLOADS_DIR, UPLOADS_TMP_DIR].forEach(dir => {
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
      console.log(`üìÅ Directorio creado: ${dir}`);
    }
  });
}

ensureDirectories();

// ===============================================================
// üåê CORS Y MIDDLEWARE B√ÅSICO (sin cambios)
// ===============================================================

// ===============================================================
// üåê CORRECCI√ìN CORS EN BACKEND - server-with-auth.ts
// ===============================================================

const corsOptions = {
  origin: [
    // Desarrollo local
    'http://localhost:5173',
    'http://localhost:3000',
    'http://127.0.0.1:5173',
    'http://localhost:4173',
    
    // ‚úÖ AGREGAR ESTAS L√çNEAS PARA TU IP:
    'http://192.168.100.151:5173',
    'http://192.168.100.151:3000',
    'http://192.168.100.151:4173',
    'http://192.168.100.151',
    
    // ‚úÖ TAMBI√âN PERMITIR SIN PUERTO (para verificaci√≥n)
    'http://192.168.100.151:5173',
  ],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: [
    'Content-Type',
    'Authorization',
    'X-Requested-With',
    'Accept',
    'Origin'
  ],
  // ‚úÖ AGREGAR ESTAS OPCIONES PARA DEBUGGING:
  optionsSuccessStatus: 200, // Para navegadores legacy
  preflightContinue: false   // Pasar control al siguiente handler
};

app.use(cors(corsOptions));

// ‚úÖ AGREGAR LOGGING DE CORS PARA DEBUG
app.use((req, res, next) => {
  console.log(`üåê ${req.method} ${req.url} from origin: ${req.headers.origin || 'no-origin'}`);
  
  // Log espec√≠fico para auth requests
  if (req.url.includes('/auth/')) {
    console.log(`üîê Auth request from: ${req.headers.origin}`);
  }
  
  next();
});

// ‚úÖ MANEJAR PREFLIGHT OPTIONS EXPL√çCITAMENTE
app.options('*', (req, res) => {
  console.log(`‚úàÔ∏è PREFLIGHT: ${req.method} ${req.url} from ${req.headers.origin}`);
  res.header('Access-Control-Allow-Origin', req.headers.origin);
  res.header('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Accept, Origin');
  res.header('Access-Control-Allow-Credentials', 'true');
  res.sendStatus(200);
});

// Parsing middleware
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));

// Request logging simple
app.use((req, res, next) => {
  const timestamp = new Date().toISOString();
  console.log(`üìù [${timestamp}] ${req.method} ${req.originalUrl}`);
  next();
});

// ===============================================================
// üìÅ ARCHIVOS EST√ÅTICOS (sin cambios)
// ===============================================================

app.use('/uploads', express.static(UPLOADS_DIR, {
  maxAge: '1d',
  etag: true,
  lastModified: true
}));

// ===============================================================
// üè• RUTAS PRINCIPALES (ACTUALIZADAS CON AUTH)
// ===============================================================

// Health check principal (actualizado)
app.get('/', (req, res) => {
  res.json({
    ok: true,
    service: 'Historia Cl√≠nica Backend',
    version: '1.1.0',
    timestamp: new Date().toISOString(),
    status: 'running',
    environment: process.env.NODE_ENV || 'development',
    features: {
      database: '‚úÖ Prisma + SQLite/PostgreSQL',
      fileUploads: '‚úÖ Multer + Almacenamiento local',
      aiAnalysis: process.env.GEMINI_API_KEY ? '‚úÖ Gemini AI habilitado' : '‚ö†Ô∏è Sin API key de Gemini',
      historiaClinica: '‚úÖ M√≥dulo completo de Historia Cl√≠nica',
      authentication: '‚úÖ JWT + Roles + Auditor√≠a',  // ‚úÖ NUEVO
      userRoles: '‚úÖ ADMIN, MEDICO, ENFERMERA, ADMINISTRATIVO'  // ‚úÖ NUEVO
    },
    endpoints: {
      health: '/health',
      auth: '/api/auth',  // ‚úÖ NUEVO
      pacientes: '/api/pacientes',
      consultas: '/api/consultas',
      laboratorio: '/api/laboratorio',
      historia: '/api/historia',
      uploads: '/uploads'
    },
    authentication: {  // ‚úÖ NUEVO
      loginEndpoint: '/api/auth/login',
      logoutEndpoint: '/api/auth/logout',
      verifyEndpoint: '/api/auth/verify',
      meEndpoint: '/api/auth/me',
      tokenType: 'Bearer JWT',
      roles: ['ADMIN', 'MEDICO', 'ENFERMERA', 'ADMINISTRATIVO']
    },
    frontend: {
      historiaClinica: 'Integraci√≥n completa con HistoriaClinica.tsx',
      loginComponent: 'Login.tsx compatible',
      expectedPort: 'http://localhost:5173'
    }
  });
});

// Health check extendido (actualizado)
app.get('/health', async (req, res) => {
  try {
    const { prisma } = await import('./db/prisma');
    
    // Verificar BD y contar usuarios
    await prisma.$queryRaw`SELECT 1`;
    const userCount = await prisma.usuario.count();
    
    res.json({
      ok: true,
      service: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: Math.floor(process.uptime()),
      memory: {
        used: Math.round(process.memoryUsage().heapUsed / 1024 / 1024) + 'MB',
        total: Math.round(process.memoryUsage().heapTotal / 1024 / 1024) + 'MB'
      },
      database: '‚úÖ Connected',
      users: `‚úÖ ${userCount} usuarios registrados`,  // ‚úÖ NUEVO
      features: {
        uploads: fs.existsSync(UPLOADS_DIR) ? '‚úÖ Ready' : '‚ùå Directory missing',
        ai: process.env.GEMINI_API_KEY ? '‚úÖ Configured' : '‚ö†Ô∏è Not configured',
        historiaClinica: '‚úÖ Module loaded',
        authentication: '‚úÖ JWT ready',  // ‚úÖ NUEVO
        audit: '‚úÖ Logging enabled'      // ‚úÖ NUEVO
      }
    });
  } catch (error) {
    console.error('‚ùå Health check failed:', error);
    res.status(503).json({
      ok: false,
      service: 'unhealthy',
      timestamp: new Date().toISOString(),
      error: 'Database connection failed',
      details: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
    });
  }
});

// ===============================================================
// üõ£Ô∏è API ROUTES (ACTUALIZADAS CON PROTECCI√ìN)
// ===============================================================

console.log('üõ£Ô∏è Configurando rutas API...');

// ‚úÖ NUEVO: Rutas de autenticaci√≥n (p√∫blicas)
app.use('/api/auth', authRouter);

// Rutas protegidas por autenticaci√≥n
app.use('/api/pacientes', requireAuth, pacientesRouter);
app.use('/api/consultas', requireAuth, consultasRouter);
app.use('/api/laboratorio', requireAuth, laboratorioRouter);
app.use('/api/historia', requireAuth, historiaRouter);

// Ejemplo de rutas con roles espec√≠ficos:
// app.use('/api/admin', requireAuth, requireRoles('ADMIN'), adminRouter);
// app.use('/api/reports', requireAuth, requireRoles('ADMIN', 'MEDICO'), reportsRouter);

// Ruta de informaci√≥n de API (actualizada)
app.get('/api', (req, res) => {
  res.json({
    ok: true,
    api: 'Historia Cl√≠nica API v1.2',
    timestamp: new Date().toISOString(),
    authentication: {  // ‚úÖ NUEVO
      required: true,
      type: 'Bearer JWT',
      roles: ['ADMIN', 'MEDICO', 'ENFERMERA', 'ADMINISTRATIVO'],
      endpoints: {
        login: 'POST /api/auth/login',
        logout: 'POST /api/auth/logout',
        verify: 'GET /api/auth/verify',
        profile: 'GET /api/auth/me'
      }
    },
    modules: [
      {
        name: 'Autenticaci√≥n',  // ‚úÖ NUEVO
        path: '/api/auth',
        description: 'Login, logout, verificaci√≥n de tokens',
        public: true
      },
      {
        name: 'Pacientes',
        path: '/api/pacientes',
        description: 'Gesti√≥n de pacientes',
        protected: true,
        requiredRoles: ['ADMIN', 'MEDICO', 'ENFERMERA', 'ADMINISTRATIVO']
      },
      {
        name: 'Consultas',
        path: '/api/consultas',
        description: 'Gesti√≥n de consultas m√©dicas',
        protected: true,
        requiredRoles: ['ADMIN', 'MEDICO', 'ENFERMERA']
      },
      {
        name: 'Laboratorio',
        path: '/api/laboratorio',
        description: 'Gesti√≥n de laboratorios con IA',
        protected: true,
        requiredRoles: ['ADMIN', 'MEDICO']
      },
      {
        name: 'Historia Cl√≠nica',
        path: '/api/historia',
        description: 'L√≠nea de tiempo y b√∫squeda integrada',
        protected: true,
        requiredRoles: ['ADMIN', 'MEDICO', 'ENFERMERA'],
        endpoints: [
          'GET /buscar?q=... - Buscar pacientes',
          'GET /paciente/:id - L√≠nea de tiempo completa',
          'GET /evento/:tipo/:id - Detalles de evento'
        ]
      }
    ],
    frontend: {
      expectedURL: 'http://localhost:5173',
      loginComponent: 'Login.tsx - Compatible con autenticaci√≥n JWT',
      authFlow: 'Login ‚Üí Dashboard ‚Üí M√≥dulos protegidos'
    }
  });
});

// ===============================================================
// üö´ MANEJO DE ERRORES (sin cambios)
// ===============================================================

app.use('*', (req, res) => {
  console.log(`‚ö†Ô∏è Ruta no encontrada: ${req.method} ${req.originalUrl}`);
  res.status(404).json({
    ok: false,
    error: 'NOT_FOUND',
    message: `Ruta ${req.method} ${req.originalUrl} no encontrada`,
    timestamp: new Date().toISOString(),
    suggestion: 'Revisar la documentaci√≥n de API en GET /',
    availableEndpoints: [
      'POST /api/auth/login - Login de usuario',  // ‚úÖ NUEVO
      'GET /api/auth/verify - Verificar token',   // ‚úÖ NUEVO
      'GET /',
      'GET /health',
      'GET /api',
      'GET /api/historia/buscar?q=maria',
      'GET /api/historia/paciente/1',
      'GET /api/pacientes',
      'POST /api/consultas/finalizar',
      'POST /api/laboratorio/upload'
    ]
  });
});

app.use(errorHandler);

// ===============================================================
// üöÄ INICIAR SERVIDOR (actualizado)
// ===============================================================

const server = app.listen(PORT, () => {
  console.log('\nüéâ ========================================');
  console.log('‚úÖ Servidor Historia Cl√≠nica + AUTH INICIADO');
  console.log('üéâ ========================================');
  console.log(`üåê URL: http://localhost:${PORT}`);
  console.log(`üìÖ Fecha: ${new Date().toLocaleString('es-EC')}`);
  console.log(`üîß Entorno: ${process.env.NODE_ENV || 'development'}`);
  console.log('');
  console.log('üìã Endpoints principales:');
  console.log(`   üè† Home: http://localhost:${PORT}/`);
  console.log(`   ‚ù§Ô∏è  Health: http://localhost:${PORT}/health`);
  console.log(`   üìä API Info: http://localhost:${PORT}/api`);
  console.log('');
  console.log('üîê Endpoints de Autenticaci√≥n:');  // ‚úÖ NUEVO
  console.log(`   üö™ Login: http://localhost:${PORT}/api/auth/login`);
  console.log(`   üö™ Logout: http://localhost:${PORT}/api/auth/logout`);
  console.log(`   ‚úÖ Verify: http://localhost:${PORT}/api/auth/verify`);
  console.log(`   üë§ Profile: http://localhost:${PORT}/api/auth/me`);
  console.log('');
  console.log('üè• Endpoints Historia Cl√≠nica (protegidos):');
  console.log(`   üîç Buscar: http://localhost:${PORT}/api/historia/buscar?q=maria`);
  console.log(`   üìã Timeline: http://localhost:${PORT}/api/historia/paciente/1`);
  console.log(`   üë• Pacientes: http://localhost:${PORT}/api/pacientes`);
  console.log('');
  console.log('üõ†Ô∏è Herramientas:');
  console.log(`   üóÑÔ∏è  Prisma Studio: npm run db:studio`);
  console.log(`   üå± Seed usuarios: npx tsx prisma/seed-usuarios.ts`);
  console.log(`   üìÅ Uploads: ${UPLOADS_DIR}`);
  console.log('');
  console.log('üîó Frontend esperado en: http://localhost:5173');
  console.log('   üìÑ Componentes: Login.tsx + Dashboard.tsx');
  console.log('   üéØ Integraci√≥n: Completa con JWT y roles');
  console.log('');
  
  // Verificaciones adicionales
  if (!process.env.JWT_SECRET) {
    console.log('‚ö†Ô∏è  ADVERTENCIA: JWT_SECRET no configurada (usando default)');
    console.log('   Configura JWT_SECRET en variables de entorno para producci√≥n');
  } else {
    console.log('üîê JWT: Configuraci√≥n personalizada detectada');
  }
  
  if (!process.env.GEMINI_API_KEY) {
    console.log('‚ö†Ô∏è  ADVERTENCIA: GEMINI_API_KEY no configurada');
    console.log('   El an√°lisis de laboratorios con IA no funcionar√°');
  } else {
    console.log('ü§ñ IA Gemini: HABILITADA para an√°lisis de laboratorios');
  }
  
  console.log('');
  console.log('üéØ ¬°Backend listo para Login.tsx + Dashboard.tsx!');
  console.log('   üìù Ejecuta: npx tsx prisma/seed-usuarios.ts para crear usuarios');
  console.log('========================================\n');
});

// Resto del c√≥digo de cierre graceful (sin cambios)
process.on('SIGTERM', () => {
  console.log('\nüõë Recibiendo SIGTERM. Cerrando servidor...');
  server.close(() => {
    console.log('‚úÖ Servidor cerrado correctamente');
    process.exit(0);
  });
});

// ... resto igual

export default app;